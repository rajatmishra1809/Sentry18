<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTRY | Venture Ready</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="style.css">
    <style> #viewReportBtn { display: none; } </style>
</head>
<body>

    <nav>
        <div class="nav-pill">
            <a href="index.html" class="logo" style="text-decoration:none;">SENTRY.</a>
            <div class="nav-links">
                <a href="index.html" class="active">Search</a>
                <a href="about.html">Mission</a>
                <a href="contact.html">Intel</a>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <div class="hero-bg"></div> <div class="hero-content">
            <h1 class="big-title">BE VENTURE<br>READY.</h1>
            <p class="elegant-subtitle">The essential guide to intelligent world exploration <br>and global travel safety with Sentry.</p>
        </div>
    </div>

    <div class="content-wrapper">
        
        <div class="search-container">
            <input type="text" id="cityInput" placeholder="Enter coordinates or city name..." autocomplete="off">
            <button class="btn-search" id="analyzeBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <div id="suggestions" class="suggestions-box"></div>
        </div>

        <div class="grid-layout">
            
            <div class="glass-panel" style="padding:0;">
                <div id="map"></div>
            </div>

            <div class="glass-panel">
                
                <div id="initialState" style="text-align: center; margin-top: 40%; opacity: 0.5;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üèîÔ∏è</div>
                    <p style="font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-style: italic;">"The mountains demand preparation."</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Awaiting target location.</p>
                </div>

                <div id="resultState" class="results-content hidden">
                    <div>
                        <div id="badge" class="safety-badge">CALCULATING</div>
                        <div id="scoreValue" class="score-huge">--</div>
                        <div id="descText" style="font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; line-height: 1.4; color: #ccc; margin-top: 10px;"></div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <h4 style="font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 10px;">Live Intelligence</h4>
                        <div id="newsFeed" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>

                    <button id="viewReportBtn" class="btn-accent" style="width: 100%; margin-top: 20px;">
                        Full Dossier ‚Üí
                    </button>
                    
                    <div id="safetyBar" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="side-drawer" id="reportDrawer">
        <div style="height: 300px; position: relative;">
            <button class="btn-search" id="closeDrawerBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; z-index: 10;">√ó</button>
            <img id="cityImage" src="" alt="City" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; bottom: 30px; left: 30px; color: white; text-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                <h2 id="drawerCityName" style="font-size: 3rem; font-weight: 800; line-height: 1;">City</h2>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <span id="coordsText" style="font-family: 'Space Grotesk'; font-size: 0.9rem;">0.00, 0.00</span>
                    <a id="mapsLink" href="#" target="_blank" style="color: white; text-decoration: underline; font-size: 0.9rem;">View Map</a>
                </div>
            </div>
        </div>

        <div style="padding: 40px;">
            <div style="margin-bottom: 3rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="text-transform: uppercase; letter-spacing: 1px; font-size: 0.8rem;">Historical Stability</h4>
                    <span id="historyTrendBadge" style="padding: 4px 10px; background: #eee; border-radius: 20px; font-size: 0.7rem; font-weight: 700; color:#000;">Analyzing</span>
                </div>
                <div style="display: flex; gap: 4px; height: 60px; align-items: flex-end;" id="historyGraph"></div>
                <p id="historyDesc" style="font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: #ccc; margin-top: 15px; font-style: italic;"></p>
            </div>

            <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color:#fff;">Risk Vectors</h3>
            <div id="categoryList"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- CONFIG ---
        const GNEWS_API_KEY = 'YOUR_API_KEY_HERE'; // Replace with your GNews API key
        
        // --- DATABASES ---
        const RISK_DB = {
            'so': { risk: 90, name: "Somalia", reason: "Active conflict zone." },
            'af': { risk: 95, name: "Afghanistan", reason: "Extreme instability." },
            'ye': { risk: 90, name: "Yemen", reason: "Humanitarian crisis." },
            'sy': { risk: 90, name: "Syria", reason: "Military conflict." },
            'ua': { risk: 80, name: "Ukraine", reason: "Active invasion zone." },
            'kp': { risk: 85, name: "North Korea", reason: "Restricted travel." }
        };

        const SAFE_DB = ['ie', 'nz', 'au', 'jp', 'ch', 'sg', 'is', 'no', 'fi', 'dk', 'se', 'ca', 'gb', 'fr', 'de', 'it', 'es', 'pt', 'us'];
        const DANGER_KEYWORDS = ["civil war", "terrorism", "militia", "bombing", "violent crime", "riots", "unsafe", "homicide", "gang violence"];

        // --- DOM ---
        const map = L.map('map', {zoomControl: false}).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
    attribution: '¬© CARTO' 
}).addTo(map);
        
        const cityInput = document.getElementById('cityInput');
        const suggestionsBox = document.getElementById('suggestions');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultState = document.getElementById('resultState');
        const initialState = document.getElementById('initialState');
        const badgeEl = document.getElementById('badge');
        const scoreEl = document.getElementById('scoreValue');
        const descEl = document.getElementById('descText');
        const newsFeedEl = document.getElementById('newsFeed');
        const safetyBarEl = document.getElementById('safetyBar');
        
        // Drawer Elements
        const viewReportBtn = document.getElementById('viewReportBtn');
        const reportDrawer = document.getElementById('reportDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const closeDrawerBtn = document.getElementById('closeDrawerBtn');
        const categoryList = document.getElementById('categoryList');
        const historyTrendBadge = document.getElementById('historyTrendBadge');
        const historyDesc = document.getElementById('historyDesc');
        const historyGraph = document.getElementById('historyGraph');
        const drawerCityName = document.getElementById('drawerCityName');
        const cityImage = document.getElementById('cityImage');
        const coordsText = document.getElementById('coordsText');
        const mapsLink = document.getElementById('mapsLink');

        let currentScore = 0;
        let currentCityData = null;
        let debounceTimer;

        // --- EVENTS ---
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                suggestionsBox.classList.remove('active');
                analyzeBtn.click();
            }
        });

        cityInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(debounceTimer);
            if (query.length < 3) { suggestionsBox.classList.remove('active'); return; }
            debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
        });

        document.addEventListener('click', (e) => {
            if (!cityInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.remove('active');
            }
        });

        // --- FIXED FETCH SUGGESTIONS (Logic Updated) ---
        async function fetchSuggestions(query) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=5`;
                const res = await fetch(url);
                const data = await res.json();
                
                suggestionsBox.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        // Use the new CSS Class instead of manual styles
                        div.className = 'suggestion-item';
                        div.textContent = item.display_name.split(',').slice(0, 2).join(',');
                        
                        div.addEventListener('click', () => {
                            cityInput.value = item.address.city || item.address.town || item.address.village || item.display_name.split(',')[0];
                            suggestionsBox.classList.remove('active');
                            analyzeBtn.click();
                        });
                        suggestionsBox.appendChild(div);
                    });
                    suggestionsBox.classList.add('active');
                } else { 
                    suggestionsBox.classList.remove('active'); 
                }
            } catch (e) { console.error(e); }
        }

        viewReportBtn.addEventListener('click', () => {
            if(!currentCityData) return;
            updateReportDrawer(currentScore, currentCityData);
            reportDrawer.classList.add('active');
            drawerOverlay.classList.add('active');
        });

        const closeDrawer = () => {
            reportDrawer.classList.remove('active');
            drawerOverlay.classList.remove('active');
        };
        closeDrawerBtn.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);

        // --- HELPER: RESET UI ---
        function resetDashboard() {
            scoreEl.textContent = '--';
            badgeEl.textContent = 'SCANNING';
            badgeEl.className = 'safety-badge'; 
            badgeEl.style.background = '#eee';
            badgeEl.style.color = '#555';
            descEl.innerHTML = 'Establishing secure uplink...';
            newsFeedEl.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Fetching global intelligence...</div>';
            viewReportBtn.style.display = 'none';
            initialState.classList.add('hidden'); // Ensure this utility class exists in CSS
            resultState.classList.remove('hidden');
        }

        // --- APIs ---
        async function getWikiData(city) {
            const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts|pageimages&exintro&explaintext&pithumbsize=800&origin=*&titles=${encodeURIComponent(city)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId === "-1") return { text: null, image: null };
                
                return {
                    text: pages[pageId].extract,
                    image: pages[pageId].thumbnail ? pages[pageId].thumbnail.source : null
                };
            } catch (error) { return { text: null, image: null }; }
        }

        async function getGNews(city) {
            const query = `"${city}" AND (crime OR violence OR safety)`;
            const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(query)}&lang=en&max=3&apikey=${GNEWS_API_KEY}`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                return data.articles;
            } catch (e) { return null; }
        }

        // --- MAIN LOGIC ---
        analyzeBtn.addEventListener('click', async () => {
            const city = cityInput.value.trim();
            if (!city) return;
            
            resetDashboard();
            analyzeBtn.textContent = '...';
            suggestionsBox.classList.remove('active');

            try {
                const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(city)}`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();
                if (!geoData || geoData.length === 0) throw new Error('City not found');
                
                const loc = geoData[0];
                map.setView([loc.lat, loc.lon], 12);
                L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(loc.display_name).openPopup();
                
                const countryCode = loc.address.country_code;
                const [wikiData, newsArticles] = await Promise.all([
                    getWikiData(city),
                    getGNews(city)
                ]);

                const intel = calculateSafety(city, countryCode, wikiData.text, newsArticles);
                
                currentScore = intel.score;
                currentCityData = { 
                    name: city, 
                    code: countryCode, 
                    intel: intel,
                    lat: loc.lat,
                    lon: loc.lon,
                    image: wikiData.image 
                };
                
                renderResults(intel);
                viewReportBtn.style.display = 'block';

            } catch (error) {
                console.log(error);
                scoreEl.textContent = '?';
                badgeEl.textContent = 'ERROR';
                descEl.innerHTML = "Location not found in database.";
            } finally {
                analyzeBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>';
            }
        });

        function calculateSafety(city, countryCode, wikiText, newsArticles) {
            let score = 90; 
            let combinedReports = [];
            let riskReason = "";
            let isRedListed = false;

            if (RISK_DB[countryCode]) {
                const dbEntry = RISK_DB[countryCode];
                score = Math.max(10, 100 - dbEntry.risk);
                riskReason = dbEntry.reason;
                isRedListed = true;
                combinedReports.push({ title: `‚ö†Ô∏è TRAVEL WARNING`, source: "SENTRY DB", snippet: `High-risk zone: ${dbEntry.reason}` });
            }
            else if (SAFE_DB.includes(countryCode)) {
                score = 95; 
            }

            if (wikiText) {
                if (!isRedListed) {
                    let penalty = 0;
                    const lowerWiki = wikiText.toLowerCase();
                    DANGER_KEYWORDS.forEach(word => {
                        if (lowerWiki.includes(word)) {
                            if (word === "war" && (lowerWiki.includes("war memorial") || lowerWiki.includes("war museum"))) return;
                            penalty += 8;
                        }
                    });
                    score -= penalty;
                }
                const snippet = wikiText.split('. ')[0] + '.';
                combinedReports.push({ title: "Regional Overview", source: "Wikipedia", snippet: snippet });
            }

            if (newsArticles && newsArticles.length > 0) {
                if (!isRedListed) score -= (newsArticles.length * 4);
                newsArticles.forEach(art => {
                    combinedReports.push({ title: art.title, source: art.source.name, snippet: art.description });
                });
            } else if (!newsArticles && !wikiText && !isRedListed) {
                score = 85; 
            }

            if (!isRedListed) {
                const variance = Math.floor(Math.random() * 7) - 3; 
                score += variance;
            }

            if (score < 10) score = 10;
            if (score > 100) score = 99;

            return { score, city, reports: combinedReports, riskReason, isRedListed };
        }

        function renderResults({ score, city, reports, riskReason }) {
            let type = 'safe'; let label = 'VERIFIED SAFE'; let text = `<strong>${city}</strong> is cleared for travel.`;
            let badgeClass = 'badge-safe';

            if (score < 60) { 
                type = 'danger'; label = 'HIGH RISK'; text = `<strong>WARNING:</strong> ${city} is a high-risk zone. ${riskReason}`; badgeClass = 'badge-danger';
            } else if (score < 80) {  
                type = 'caution'; label = 'CAUTION'; text = `<strong>Notice:</strong> Exercise vigilance in ${city}.`; badgeClass = 'badge-caution';
            }

            scoreEl.textContent = `${score}%`; 
            badgeEl.textContent = label; 
            badgeEl.className = `safety-badge ${badgeClass}`;
            badgeEl.style.background = ''; 
            badgeEl.style.color = '';
            
            descEl.innerHTML = text;
            
            newsFeedEl.innerHTML = '';
            reports.forEach(rep => {
                const item = document.createElement('div');
                item.className = 'news-item';
                item.innerHTML = `<div class="news-title">${rep.title}</div><div class="news-source">${rep.source}</div>`;
                newsFeedEl.appendChild(item);
            });
        }

        function updateReportDrawer(mainScore, cityData) {
            drawerCityName.textContent = cityData.name;
            const fallbackImage = 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=3540&auto=format&fit=crop'; 
            cityImage.src = cityData.image ? cityData.image : fallbackImage;
            
            coordsText.textContent = `${parseFloat(cityData.lat).toFixed(2)}, ${parseFloat(cityData.lon).toFixed(2)}`;
            mapsLink.href = `https://www.google.com/maps/search/?api=1&query=${cityData.lat},${cityData.lon}`;

            let trend = "Stable";
            if (mainScore > 85) trend = "Positive";
            if (mainScore < 60) trend = "Volatile";
            
            historyTrendBadge.textContent = trend;
            historyDesc.innerHTML = `Long-term analysis for <strong>${cityData.name}</strong> suggests a <strong>${trend.toLowerCase()}</strong> security environment based on multi-vector analysis.`;

            historyGraph.innerHTML = '';
            for(let i=0; i<15; i++) {
                let h = (mainScore * 0.5) + (Math.random() * 10); 
                if (h > 100) h = 100;
                let bar = document.createElement('div');
                bar.style.width = "6%"; bar.style.height = h + "%"; bar.style.background = "#D97706"; bar.style.borderRadius = "2px"; bar.style.opacity = "0.7";
                historyGraph.appendChild(bar);
            }

            const categories = [
                { name: "Political Stability", icon: "‚öñÔ∏è" },
                { name: "Tourist Safety", icon: "üì∏" },
                { name: "Violent Crime", icon: "üî´" },
                { name: "Women's Safety", icon: "üë©" },
                { name: "Health Services", icon: "üè•" },
                { name: "Civil Rights", icon: "‚úä" }
            ];

            categoryList.innerHTML = '';

            categories.forEach(cat => {
                let val;
                if (mainScore >= 80) val = (Math.random() * (10.0 - 8.0) + 8.0).toFixed(1);
                else if (mainScore >= 60) val = (Math.random() * (7.9 - 6.0) + 6.0).toFixed(1);
                else val = (Math.random() * (5.9 - 2.0) + 2.0).toFixed(1);

                const item = document.createElement('div');
                item.style.marginBottom = '20px';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600; font-size:0.9rem;">
                        <span>${cat.name}</span>
                        <span>${val}/10</span>
                    </div>
                    <div style="width:100%; height:6px; background:#f0f0f0; border-radius:10px;">
                        <div style="width:${val * 10}%; height:100%; background:#1a1a1a; border-radius:10px;"></div>
                    </div>
                `;
                categoryList.appendChild(item);
            });
        }
    </script>
</body>
</html>